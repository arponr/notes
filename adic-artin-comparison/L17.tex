\documentclass[11pt,leqno]{article}

\linespread{1.1}
\frenchspacing

\usepackage[%
  tmargin=1in,bmargin=1in,%
  lmargin=1.6in,rmargin=1.6in,%
  %marginparsep=0.2in, marginparwidth=1.8in%
]{geometry}
\setlength{\skip\footins}{3.0ex}

\usepackage{datetime2}
\usepackage{fancyhdr}
\usepackage{titlesec}
\usepackage{appendix}
\usepackage{microtype}
\usepackage[bottom]{footmisc}
\usepackage[hyphens]{url}
\usepackage{enumitem}
\usepackage{xspace}
\usepackage{calc}
\usepackage{etoolbox}
\usepackage{ifthen}
\usepackage{tikz}
\usepackage{tikz-cd}

\definecolor{darkred}{rgb}{0.5,0.0,0.0}
\usepackage[%
  hyperfootnotes=false,
  colorlinks,%
  linkcolor=darkred,%
  citecolor=darkred,%
  urlcolor=darkred,%
]{hyperref}
\urlstyle{rm}

\usepackage{fourier}
\usepackage[osf,scaled=.92]{heuristica}
\usepackage[%
  cal=euler,    calscaled=0.96,%
  scr=boondox,  scrscaled=0.95,%
  bb=boondox,   bbscaled=1.0,%
  frak=boondox, frakscaled=0.95,%
  ]{mathalfa}
\usepackage{amsmath,amsthm,amssymb}
\usepackage[textsize=footnotesize,backgroundcolor=orange!50]{todonotes}
\usepackage{cleveref}
\usepackage{xr}




\AtBeginDocument{%
  \setlength{\abovedisplayskip}{1.5ex plus 0.3ex minus 0.3ex}%
  \setlength{\abovedisplayshortskip}{1.0ex plus 0.3ex minus 0.3ex}%
  \setlength{\belowdisplayskip}{1.5ex plus 0.3ex minus 0.3ex}%
  \setlength{\belowdisplayshortskip}{1.0ex plus 0.3ex minus 0.3ex}%
}

\let\theoldbibliography\thebibliography
\renewcommand{\thebibliography}[1]{%
  \theoldbibliography{#1}%
  \setlength{\parskip}{0ex}
  \setlength{\itemsep}{0.5ex plus 0.2ex minus 0.2ex}
  \small
}
\apptocmd{\thebibliography}{\raggedright}{}{}

\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\fancyhf{}
\fancyfoot[C]{\small\thepage}

\renewcommand{\title}[1]{\newcommand{\thetitle}{#1}}
\renewcommand{\author}[1]{\newcommand{\theauthor}{#1}}
\renewcommand{\date}[1]{\newcommand{\thedate}{#1}}

\renewcommand{\maketitle}{%
  \begin{flushleft}
    {\bfseries\MakeUppercase{%
      \thetitle}}\\[1.5ex]
    {\footnotesize\MakeUppercase{%
      \theauthor}}\\[1.5ex]
    \ifthenelse{\equal{\thedate}{}}{}{%
      \small%
      % \setlength{\tabcolsep}{0.2em}%
      % \begin{tabular}{rl}
        original: \thedate \\
        updated: \today
      % \end{tabular}
    }
  \end{flushleft}
  \vspace{2.5ex}
  \thispagestyle{fancy}
}

\renewenvironment{abstract}{\section*{Abstract}}{}


% ---------------------------------------------------------------------

\newlength{\tagsep}
\setlength{\tagsep}{1em}

% center display math with respect to full page
% -- amsart.cls
\makeatletter
\def\fullwidthdisplay{\displayindent\z@ \displaywidth\columnwidth}
\edef\@tempa{\noexpand\fullwidthdisplay\the\everydisplay}
\everydisplay\expandafter{\@tempa}
\makeatother

% equation numbering in left margin
% -- http://tex.stackexchange.com/questions/59244
\makeatletter
\let\mytagform@=\tagform@
\def\tagform@#1{\maketag@@@{\hbox{\llap{\ignorespaces#1\unskip\@@italiccorr\hspace{\tagsep}}}}\kern1sp}
\renewcommand{\eqref}[1]{{\mytagform@{\ref{#1}}}}
\makeatother

\titleformat{\section}{\bfseries}{\llap{\S\thesection\hspace{\tagsep}}}{0em}{}
\titlespacing*{\section}{0pt}{*6}{*2}
\titleformat{\subsection}{\scshape}{\llap{\S\thesubsection\hspace{\tagsep}}}{0em}{}
\titlespacing*{\subsection}{0pt}{*4}{*2}

% Display format for equations
\newcommand{\crefeqfmt}[1]{
  \crefformat{#1}{(##2##1##3)}
  \Crefformat{#1}{(##2##1##3)}
  \crefrangeformat{#1}{(##3##1##4--##5##2##6)}
  \Crefrangeformat{#1}{(##3##1##4--##5##2##6)}
  \crefmultiformat{#1}{(##2##1##3}{, ##2##1##3)}{, ##2##1##3}{, ##2##1##3)}
  \Crefmultiformat{#1}{(##2##1##3}{, ##2##1##3)}{, ##2##1##3}{, ##2##1##3)}
  \crefrangemultiformat{#1}{(##3##1##4--##5##2##6}{, ##3##1##4--##5##2##6)}{, ##3##1##4--##5##2##6}{, ##3##1##4--##5##2##6)}
  \Crefrangemultiformat{#1}{(##3##1##4--##5##2##6}{, ##3##1##4--##5##2##6)}{, ##3##1##4--##5##2##6}{, ##3##1##4--##5##2##6)}
}
% Display format for sections
\newcommand{\crefsecfmt}[1]{%
  \crefformat{#1}{\S##2##1##3}
  \Crefformat{#1}{\S##2##1##3}
  \crefrangeformat{#1}{\S\S##3##1##4--##5##2##6}
  \Crefrangeformat{#1}{\S\S##3##1##4--##5##2##6}
  \crefmultiformat{#1}{\S\S##2##1##3}{ and~##2##1##3}{, ##2##1##3}{ and~##2##1##3}
  \Crefmultiformat{#1}{\S\S##2##1##3}{ and~##2##1##3}{, ##2##1##3}{ and~##2##1##3}
  \crefrangemultiformat{#1}{\S\S##3##1##4--##5##2##6}{ and~##3##1##4--##5##2##6}{, ##3##1##4--##5##2##6}{ and~##3##1##4--##5##2##6}
  \Crefrangemultiformat{#1}{\S\S##3##1##4--##5##2##6}{ and~##3##1##4--##5##2##6}{, ##3##1##4--##5##2##6}{ and~##3##1##4--##5##2##6}
}
\crefeqfmt{equation}
\crefeqfmt{enumi}
\crefeqfmt{enumii}
\crefsecfmt{section}
\crefsecfmt{subsection}
\crefsecfmt{appendix}
\crefname{part}{Part}{Parts}
\crefname{chapter}{Chapter}{Chapters}
\crefname{figure}{Figure}{Figures}

\makeatletter


\newcommand{\thmnumfont}{}
\newcommand{\thmheadfont}{\scshape}
\newcommand{\thmnotefont}{\scshape}
\newcommand{\thmhorizspace}{0.3em}
\newcommand{\thmnotespace}{0.25em}
\newcommand{\thmsep}{\hspace{\thmhorizspace}---}

\newtheoremstyle{block}%
  {1.5ex plus 0.1ex minus 0.1ex}% Space above
  {1.5ex plus 0.1ex minus 0.1ex}% Space below
  {}% Body font
  {}% Indent amount
  {\thmheadfont} % Theorem head font
  {}% Punctuation after theorem head
  {0em}% Space after theorem head
  {\llap{\thmnumber{{\thmnumfont #2}\hspace{\tagsep}}}%
    \thmname{#1}%
    \thmnote{\hspace{\thmnotespace}\thmnotefont(#3)}%
    \@ifnotempty{#1}{\thmsep\hspace{\thmhorizspace}}%
  }% Custom head spec

\newcommand{\defemph}[1]{\textit{#1}}

\renewenvironment{proof}[1][Proof]{\par
  \pushQED{\qed}%
  \normalfont%
  \topsep1ex plus 0.2ex minus 0.1ex\relax%
  \labelsep \thmhorizspace\relax%
  \trivlist
  \item[\hskip\labelsep\thmheadfont#1\@addpunct{\thmsep}]\ignorespaces
}{%
  \popQED\endtrivlist\@endpefalse%
}

\makeatother

\theoremstyle{block}

\newcounter{block}
\newcounter{subblock}
\numberwithin{subblock}{block}
\numberwithin{equation}{subblock}

\newcommand{\defthm}[2]{%
  \newtheorem{#1}[block]{#2}%
  \crefeqfmt{#1}%
  \newtheorem*{#1*}{#2}%

  \newtheorem{sub#1}[subblock]{#2}%
  \crefeqfmt{sub#1}%
  \newtheorem*{sub#1*}{#2}%
}

\defthm{algorithm}{Algorithm}
\defthm{assumption}{Assumption}
\defthm{case}{Case}
\defthm{claim}{Claim}
\defthm{conjecture}{Conjecture}
\defthm{construction}{Construction}
\defthm{convention}{Convention}
\defthm{corollary}{Corollary}
\defthm{definition}{Definition}
\defthm{definitions}{Definitions}
\defthm{example}{Example}
\defthm{examples}{Examples}
\defthm{exercise}{Exercise}
\defthm{fact}{Fact}
\defthm{intuition}{Intuition}
\defthm{lemma}{Lemma}
\defthm{notation}{Notation}
\defthm{nothing}{}
\defthm{proposition}{Proposition}
\defthm{question}{Question}
\defthm{recall}{Recall}
\defthm{remark}{Remark}
\defthm{remarks}{Remarks}
\defthm{situation}{Situation}
\defthm{terminology}{Terminology}
\defthm{theorem}{Theorem}

\makeatletter
\long\def\XR@test#1#2#3#4\XR@{%
  \ifx#1\newlabel
    \xr@cref#2@cref\relax#3\@nil
  \else\ifx#1\@input
     \edef\XR@list{\XR@list#2\relax}%
  \fi\fi
  \ifeof\@inputcheck\expandafter\XR@aux
  \else\expandafter\XR@read\fi}

\def\xr@@cref{@cref}
\def\xr@cr@add#1{{[\XR@prefix\@gobble#1}}
\def\xr@cref#1@cref#2\relax#3\@nil{%
\def\tmp{#2}%
\ifx\tmp\xr@@cref
  \edef\tmp{\noexpand\newlabel{\XR@prefix#1@cref}{\xr@cr@add#3}}%
  \tmp
\else
 \newlabel{\XR@prefix#1}{#3}%
\fi
}
\makeatother

% Display format for equations
\newcommand{\externalcrefeqfmt}[2]{
  \crefformat{#1:#2}{[\texttt{#1}, ##2##1##3]}
  \Crefformat{#1:#2}{[\texttt{#1}, ##2##1##3]}
  \crefrangeformat{#1:#2}{[\texttt{#1}, ##3##1##4--##5##2##6]}
  \Crefrangeformat{#1:#2}{[\texttt{#1}, ##3##1##4--##5##2##6]}
  \crefmultiformat{#1:#2}{[\texttt{#1}, ##2##1##3}{, ##2##1##3]}{, ##2##1##3}{, ##2##1##3]}
  \Crefmultiformat{#1:#2}{[\texttt{#1}, ##2##1##3}{, ##2##1##3]}{, ##2##1##3}{, ##2##1##3]}
  \crefrangemultiformat{#1:#2}{[\texttt{#1}, ##3##1##4--##5##2##6}{, ##3##1##4--##5##2##6]}{, ##3##1##4--##5##2##6}{, ##3##1##4--##5##2##6]}
  \Crefrangemultiformat{#1:#2}{[\texttt{#1}, ##3##1##4--##5##2##6}{, ##3##1##4--##5##2##6]}{, ##3##1##4--##5##2##6}{, ##3##1##4--##5##2##6]}
}
% Display format for sections
\newcommand{\externalcrefsecfmt}[2]{%
  \crefformat{#1:#2}{[\texttt{#1}, \S##2##1##3]}
  \Crefformat{#1:#2}{[\texttt{#1}, \S##2##1##3]}
  \crefrangeformat{#1:#2}{[\texttt{#1}, \S\S##3##1##4--##5##2##6]}
  \Crefrangeformat{#1:#2}{[\texttt{#1}, \S\S##3##1##4--##5##2##6]}
  \crefmultiformat{#1:#2}{[\texttt{#1}, \S\S##2##1##3}{ and~##2##1##3]}{, ##2##1##3}{ and~##2##1##3]}
  \Crefmultiformat{#1:#2}{[\texttt{#1}, \S\S##2##1##3}{ and~##2##1##3]}{, ##2##1##3}{ and~##2##1##3]}
  \crefrangemultiformat{#1:2}{[\texttt{#1}, \S\S##3##1##4--##5##2##6}{ and~##3##1##4--##5##2##6]}{, ##3##1##4--##5##2##6}{ and~##3##1##4--##5##2##6]}
  \Crefrangemultiformat{#1:#2}{[\texttt{#1}, \S\S##3##1##4--##5##2##6}{ and~##3##1##4--##5##2##6]}{, ##3##1##4--##5##2##6}{ and~##3##1##4--##5##2##6]}
}

\newcommand{\GRAINROOT}{/Users/arpon/Documents/grain}
\newcommand{\externalgrain}[1]{
  \externaldocument[#1:]{\GRAINROOT /nodes/#1/#1}
  
  \externalcrefeqfmt{#1}{algorithm}
  \externalcrefeqfmt{#1}{case}
  \externalcrefeqfmt{#1}{conjecture}
  \externalcrefeqfmt{#1}{construction}
  \externalcrefeqfmt{#1}{convention}
  \externalcrefeqfmt{#1}{corollary}
  \externalcrefeqfmt{#1}{definition}
  \externalcrefeqfmt{#1}{definitions}
  \externalcrefeqfmt{#1}{example}
  \externalcrefeqfmt{#1}{examples}
  \externalcrefeqfmt{#1}{exercise}
  \externalcrefeqfmt{#1}{fact}
  \externalcrefeqfmt{#1}{intuition}
  \externalcrefeqfmt{#1}{lemma}
  \externalcrefeqfmt{#1}{notation}
  \externalcrefeqfmt{#1}{nothing}
  \externalcrefeqfmt{#1}{proposition}
  \externalcrefeqfmt{#1}{question}
  \externalcrefeqfmt{#1}{recall}
  \externalcrefeqfmt{#1}{remark}
  \externalcrefeqfmt{#1}{remarks}
  \externalcrefeqfmt{#1}{situation}
  \externalcrefeqfmt{#1}{theorem}

  \externalcrefeqfmt{#1}{equation}
  \externalcrefeqfmt{#1}{enumi}
  \externalcrefeqfmt{#1}{enumii}
  \externalcrefsecfmt{#1}{section}
  \externalcrefsecfmt{#1}{subsection}
  \externalcrefsecfmt{#1}{appendix}
}

\setlist{%
  parsep=0ex, listparindent=\parindent,%
  itemsep=0.75ex, topsep=0.75ex,%
  leftmargin=2.5em,%
}

\setlist[enumerate, 1]{%
  label=(\emph{\alph*}),%
  ref={\emph{\alph*}},%
  widest=d,
}
\setlist[enumerate, 2]{%
  leftmargin=*,%
  label=(\theenumi.\arabic*),%
  ref=\theenumi.\arabic*,%
}
\setlist[itemize, 1]{%
  label=$\vcenter{\hbox{\footnotesize$\blacktriangleright$}}$,%
}
\setlist[itemize, 2]{%
  label=--,%
}

% ---------------------------------------------------------------------

\makeatletter

\let\ea\expandafter

\newcount\foreachcount

\def\foreachletter#1#2#3{\foreachcount=#1
  \ea\loop\ea\ea\ea#3\@alph\foreachcount
  \advance\foreachcount by 1
  \ifnum\foreachcount<#2\repeat}

\def\foreachLetter#1#2#3{\foreachcount=#1
  \ea\loop\ea\ea\ea#3\@Alph\foreachcount
  \advance\foreachcount by 1
  \ifnum\foreachcount<#2\repeat}

% Roman: \rA is \mathrm{A}
\def\definerm#1{%
  \ea\gdef\csname r#1\endcsname{\ensuremath{\mathrm{#1}}\xspace}}
\foreachLetter{1}{27}{\definerm}
\foreachletter{1}{27}{\definerm}
% Script: \sA is \mathscr{A}
\def\definescr#1{%
  \ea\gdef\csname s#1\endcsname{\ensuremath{\mathscr{#1}}\xspace}}
\foreachLetter{1}{27}{\definescr}
% Calligraphic: \cA is \mathcal{A}
\def\definecal#1{%
  \ea\gdef\csname c#1\endcsname{\ensuremath{\mathcal{#1}}\xspace}}
\foreachLetter{1}{27}{\definecal}
% Bold: \bA is \mathbf{A}
\def\definebold#1{%
  \ea\gdef\csname b#1\endcsname{\ensuremath{\mathbf{#1}}\xspace}}
\foreachLetter{1}{27}{\definebold}
% Blackboard Bold: \lA is \mathbb{A}
\def\definebb#1{%
  \ea\gdef\csname l#1\endcsname{\ensuremath{\mathbb{#1}}\xspace}}
\foreachLetter{1}{27}{\definebb}
% Fraktur: \ka is \mathfrak{a}, \kA is \mathfrak{A}
\def\definefrak#1{%
  \ea\gdef\csname k#1\endcsname{\ensuremath{\mathfrak{#1}}\xspace}}
\foreachletter{1}{27}{\definefrak}
\foreachLetter{1}{27}{\definefrak}
% Sans serif: \iA \is \mathsf{A}
\def\definesf#1{%
  \ea\gdef\csname i#1\endcsname{\ensuremath{\mathsf{#1}}\xspace}}
\foreachletter{1}{6}{\definesf}
\foreachletter{7}{14}{\definesf}
\foreachletter{15}{27}{\definesf}
\foreachLetter{1}{27}{\definesf}
% Bar: \Abar is \overline{A}, \abar is \overline{a}
\def\definebar#1{%
  \ea\gdef\csname #1bar\endcsname{\ensuremath{\overline{#1}}\xspace}}
\foreachLetter{1}{27}{\definebar}
\foreachletter{1}{8}{\definebar} % \hbar is something else!
\foreachletter{9}{15}{\definebar} % \obar is something else!
\foreachletter{16}{27}{\definebar}
% Tilde: \Atil is \widetilde{A}, \atil is \widetilde{a}
\def\definetil#1{%
  \ea\gdef\csname #1til\endcsname{\ensuremath{\widetilde{#1}}\xspace}}
\foreachLetter{1}{27}{\definetil}
\foreachletter{1}{27}{\definetil}
% Hats: \Ahat is \widehat{A}, \ahat is \widehat{a}
\def\definehat#1{%
  \ea\gdef\csname #1hat\endcsname{\ensuremath{\widehat{#1}}\xspace}}
\foreachLetter{1}{27}{\definehat}
\foreachletter{1}{27}{\definehat}
% Checks: \Achk is \widecheck{A}, \achk is \widecheck{a}
\def\definechk#1{%
  \ea\gdef\csname #1chk\endcsname{\ensuremath{\widecheck{#1}}\xspace}}
\foreachLetter{1}{27}{\definechk}
\foreachletter{1}{27}{\definechk}
% Underline: \Aund is \underline{A}, \aund is \underline{a}
\def\defineul#1{%
  \ea\gdef\csname #1und\endcsname{\ensuremath{\underline{#1}}\xspace}}
\foreachLetter{1}{27}{\defineul}
\foreachletter{1}{27}{\defineul}

\makeatother

% ---------------------------------------------------------------------

\usetikzlibrary{calc,decorations.pathmorphing,shapes,arrows}
\tikzcdset{
  arrow style=tikz,
  diagrams={>={stealth}},
}

\newcommand{\arrlen}{1.25em}
\newcommand{\shortarrlen}{0.85em}
\renewcommand{\to}{\mathrel{\tikz[baseline]%
    \draw[>=stealth,->](0,0.5ex)--(\arrlen,0.5ex);}}
\newcommand{\limto}{\mathrel{\tikz[baseline]%
    \draw[>=stealth,->](0,0.4ex)--(\shortarrlen,0.4ex);}}
\newcommand{\from}{\mathrel{\tikz[baseline]%
    \draw[>=stealth,<-](0,0.5ex)--(\arrlen,0.5ex);}}
\renewcommand{\mapsto}{\mathrel{\tikz[baseline]%
    \draw[>=stealth,|->](0,0.5ex)--(\arrlen,0.5ex);}}
\newcommand{\inj}{\mathrel{\tikz[baseline]%
    \draw[>=stealth,right hook->](0,0.5ex)--(\arrlen,0.5ex);}}
\newcommand{\surj}{\mathrel{\tikz[baseline]%
    \draw[>=stealth,->>](0,0.5ex)--(\arrlen,0.5ex);}}
\newcommand{\fromto}{\mathrel{%
  \begin{tikzpicture}[baseline]%
    \draw[>=stealth,<-](0,0.15ex)--(\arrlen,0.15ex);%
    \draw[>=stealth,->](0,0.85ex)--(\arrlen,0.85ex);%
  \end{tikzpicture}}}
\newcommand{\doubto}{\mathrel{%
  \begin{tikzpicture}[baseline]%
    \draw[>=stealth,->](0,0.15ex)--(\arrlen,0.15ex);%
    \draw[>=stealth,->](0,0.85ex)--(\arrlen,0.85ex);%
  \end{tikzpicture}}}
\newcommand{\goesto}{\mathrel{%
  \begin{tikzpicture}[baseline= {( $ (current bounding box.south) + (0,-0.3ex) $ )}]%
    \draw[>=stealth,->,decorate,%
          decoration={zigzag,amplitude=0.15ex,segment length=0.35em,pre=lineto,pre length=.15em,post=lineto,post length=.3em}](0,0.15ex)--(\arrlen,0.15ex);%
  \end{tikzpicture}}}
\newcommand{\lblto}[1]{\mathrel{%
    \begin{tikzpicture}[baseline= {( $ (current bounding box.south) + (0,-0.5ex) $ )}]
      \node[inner sep=.4ex] (a) {\,$\scriptstyle #1$\,};
      \draw[>=stealth,->] (a.south west) -- (a.south east);
    \end{tikzpicture}}}
\newcommand{\isoto}{\lblto{\sim}}

\newcommand{\simpl}[3]{
  \begin{tikzcd}[ampersand replacement=\&, column sep=small]
    #1 \&
    #2 \ar[l, shift right=0.35ex]
       \ar[l, shift left=0.35ex] \&
    #3 \ar[l, shift right=0.70ex]
       \ar[l, shift left=0.70ex]
       \ar[l] \&
    \cdots \ar[l, shift right=0.35ex]
           \ar[l, shift left=0.35ex]
           \ar[l, shift right=1.05ex]
           \ar[l, shift left=1.05ex]
  \end{tikzcd}
}
\newcommand{\cosimpl}[3]{
  \begin{tikzcd}[ampersand replacement=\&, column sep=small]
    #1 \ar[r, shift right=0.35ex]
       \ar[r, shift left=0.35ex] \&
    #2 \ar[r, shift right=0.70ex]
       \ar[r, shift left=0.70ex]
       \ar[r] \&
    #3 \ar[r, shift right=0.35ex]
       \ar[r, shift left=0.35ex]
       \ar[r, shift right=1.05ex]
       \ar[r, shift left=1.05ex] \&
    \cdots
  \end{tikzcd}
}

\newcommand{\tto}{\mathrel{\tikz[baseline]%
    \draw[>=stealth,->,double, double distance = 0.3ex](0,0.5ex)--(\arrlen,0.5ex);}}
\newcommand{\doubfrom}{\mathrel{%
  \begin{tikzpicture}[baseline]%
    \draw[>=stealth,<-](0,0.15ex)--(\arrlen,0.15ex);%
    \draw[>=stealth,<-](0,0.85ex)--(\arrlen,0.85ex);%
  \end{tikzpicture}}}
\newcommand{\tripfrom}{\mathrel{%
  \begin{tikzpicture}[baseline]%
    \draw[>=stealth,<-](0,0.00ex)--(\arrlen,0.00ex);%
    \draw[>=stealth,<-](0,0.50ex)--(\arrlen,0.50ex);%
    \draw[>=stealth,<-](0,1.00ex)--(\arrlen,1.00ex);%
  \end{tikzpicture}}}


\renewcommand{\l}{\left}
\renewcommand{\r}{\right}
\renewcommand{\f}{\frac}
\renewcommand{\o}{\overline}
\renewcommand{\u}{\underline}
\newcommand{\til}{\widetilde}
\renewcommand{\hat}{\widehat}
\newcommand{\del}{\partial}
\newcommand{\bul}{\bullet}
\newcommand{\dash}{\text{-}}
\renewcommand{\c}{\colon}
\newcommand{\lc}{\,:\!}
\newcommand{\ce}{\mathrel{:=}}%{\coloneq}
\newcommand{\ec}{\mathrel{=:}}%{\eqcolon}
\newcommand{\iso}{\simeq}
\newcommand{\lbliso}[1]{\overset{#1}{\simeq}}
\newcommand{\dual}[1]{#1^\vee}
\newcommand{\ldb}{\llbracket}
\newcommand{\rdb}{\rrbracket}
\newcommand{\shimplies}{\Rightarrow}
\newcommand{\shimplied}{\Leftarrow}

\newcommand{\Obj}{\operatorname{Obj}}
\newcommand{\Hom}{\operatorname{Hom}}
\newcommand{\Map}{\operatorname{Map}}
\newcommand{\Fun}{\operatorname{Fun}}
\newcommand{\Aut}{\operatorname{Aut}}
\newcommand{\End}{\operatorname{End}}
\newcommand{\Iso}{\operatorname{Iso}}
\renewcommand{\id}{\mathrm{id}}
\renewcommand{\im}{\operatorname{im}}
\newcommand{\pt}{\star}
\newcommand{\op}{\mathrm{op}}
\newcommand{\univ}{\mathrm{univ}}
\newcommand{\colim}{\operatorname*{colim}}
\newcommand{\coeq}{\operatorname*{coeq}}
\newcommand{\eq}{\operatorname*{eq}}
\newcommand{\dlim}{\displaystyle\lim}
\newcommand{\dcolim}{\displaystyle\colim}
\newcommand{\Spec}{\operatorname{Spec}}
\newcommand{\Spf}{\operatorname{Spf}}

% ---------------------------------------------------------------------


\title{Adic Artin comparison}
\author{Arpon Raksit}
\date{2017-03-05}

\numberwithin{block}{section}

\begin{document}
\maketitle

\newcommand{\an}{\mathrm{an}}
\newcommand{\Ab}{\mathrm{Ab}}
\newcommand{\red}{\mathrm{red}}

% ---------------------------------------------------------------------

The goal is to extend the Artin comparison theorem from the setting of torsion coefficients to the setting of adic coefficients. We will essentially be following the presentation of \cite[\S\S 1.4.7--1.4.8]{conrad-etale}, and we should repeat the note from there that the main argument of \cref{an} is due to Deligne.

\begin{notation}
  \label{intro-ntn}
  Throughout, $\Lambda$ is a complete discrete valuation ring with uniformizer $\ell$, characteristic zero fraction field $K$, and finite residue field $\Lambda_0 \ce \Lambda/\ell \Lambda$.
\end{notation}

% ---------------------------------------------------------------------

\section{Adic analytification}
\label{an}

\begin{notation}
  \label{an-ntn}
  Throughout this section we let $X$ be a finite-type $\bC$-scheme.
\end{notation}

\begin{definition}
  \label{an-dfn}
  Suppose given an object $\sF_\bullet$ in the Artin-Rees category of $\Lambda$-sheaves on $X$. We may analytify $\sF_n \goesto \sF_n^\an$, and obtain an object $\sG_\bullet$ in the Artin-Rees category of $\Lambda$-sheaves on $X^\an$. We then define
  \[
    \sF_\bullet^\an \ce \lim \sG_\bullet = \lim \sF_n^\an,
  \]
  a sheaf of $\Lambda$-modules on $X^\an$. As taking limits is a functor on the Artin-Rees category of $\Lambda$-sheaves on $X^\an$, this construction defines a functor from the Artin-Rees category of $\Lambda$-sheaves on $X$ to the category of sheaves of $\Lambda$-modules on $X^\an$.
\end{definition}

Our aim in this section is to demonstrate that this adic analytification construction has good properties. The key result is the following.

\begin{lemma}
  \label{an-lim-stalk}
  Let $\sF_\bullet$ be a constructible $\Lambda$-sheaf on $X$. Then, for $x \in X(\bC)$, the canonical map
  \[
    \iota_x \c \l(\sF_\bullet^\an\r)_x = \l(\lim \sF_n^\an\r)_x \to
    \lim {\l(\sF_n^\an\r)_x} \iso \lim {\l(\sF_n\r)_x} = \l(\sF_\bullet\r)_x
  \]
  is an isomorphism.
\end{lemma}

Before proving this lemma, let us give some consequences.

\begin{corollary}
  \label{an-exact}
  The analytification functor $\sF_\bullet \goesto \sF_\bullet^\an$ defined in \cref{an-dfn} is exact.

  \begin{proof}
    On both sides of the functor exactness may be checked on stalks, so this is immediate from \cref{an-lim-stalk}.
  \end{proof}
\end{corollary}

\begin{corollary}
  \label{an-open}
  Let $j \c U \inj X$ be an open immersion.
  \begin{enumerate}
  \item \label{an-open-push}
     Let $\sF_\bullet$ be a constructible $\Lambda$-sheaf on $U$. Then the canonical map
    \[
      j^\an_!(\sF_\bullet^\an) \to \lim j^\an_!(\sF_n^\an) = \l(j_!(\sF_\bullet)\r)^\an
    \]
    is an isomorphism.
  \item \label{an-open-pull}
    Let $\sF_\bullet$ be a constructible $\Lambda$-sheaf on $X$. Then the canonical map
    \[
      (j^\an)^*(\sF_\bullet^\an) \to \lim {(j^\an)^*(\sF_n^\an)} = \l(j^*(\sF_\bullet)\r)^\an
    \]
    is an isomorphism.
  \end{enumerate}

  \begin{proof}
    \begin{enumerate}[leftmargin=*]
    \item It follows from \cref{an-lim-stalk} that the map induces isomorphisms on stalks.
    \item This is immediate from $(j^\an)^*$ preserving limits. \qedhere
    \end{enumerate}
  \end{proof}
\end{corollary}

\begin{corollary}
  \label{an-closed}
  Let $i \c Z \inj X$ be an closed immersion.
  \begin{enumerate}
  \item \label{an-closed-push}
     Let $\sF_\bullet$ be a constructible $\Lambda$-sheaf on $Z$. Then the canonical map
    \[
      i^\an_*(\sF_\bullet^\an) \to \lim i^\an_*(\sF_n^\an) = \l(i_*(\sF_\bullet)\r)^\an
    \]
    is an isomorphism.
  \item \label{an-closed-pull}
    Let $\sF_\bullet$ be a constructible $\Lambda$-sheaf on $X$. Then the canonical map
    \[
      (i^\an)^*(\sF_\bullet^\an) \to \lim (i^\an)^*(\sF_n^\an) = \l(i^*(\sF_\bullet)\r)^\an
    \]
    is an isomorphism.
  \end{enumerate}

  \begin{proof}
    \begin{enumerate}[leftmargin=*]
    \item This is immediate from pushforward $i^\an_*$ preserving limits.
    \item Let $j \c U \inj X$ be the open complement of $i \c Z \inj X$. We have an exact sequence
      \[
        0 \to j_!j^*\sF_\bullet \to \sF_\bullet \to i_*i^*\sF_\bullet \to 0
      \]
      which by \cref{an-exact} analytifies to an exact sequence
      \[
        0 \to \l(j_!j^*\sF_\bullet\r)^\an \to \sF_\bullet^\an \to \l(i_*i^*\sF_\bullet\r)^\an \to 0.
      \]
      We also have an exact sequence
      \[
        0 \to j_!^\an(j^\an)^*\sF_\bullet^\an \to \sF_\bullet^\an \to i^\an_*(i^\an)^*\sF_\bullet^\an \to 0.
      \]
      By \cref{an-open} and \cref{an-closed-push} we get
      \[
        j_!^\an (j^\an)^* \sF_\bullet^\an \isoto \l(j_!j^*\sF_\bullet\r)^\an, \quad
        i^\an_*\l(i^*\sF_\bullet\r)^\an \isoto \l(i_*i^*\sF_\bullet\r)^\an.
      \]
      From all this we deduce that the canonical map
      \[
        i^\an_*(i^\an)^*\sF_\bullet^\an \to i^\an_*\l(i^*\sF_\bullet\r)^\an
      \]
      is an isomorphism, which implies the claim. \qedhere
    \end{enumerate}
  \end{proof}
\end{corollary}

\begin{corollary}
  \label{an-lisse-local}
  Suppose $\sF_\bullet$ is a lisse $\Lambda$-sheaf on $X$. Then $\sF_\bullet^\an$ is a local system of finite $\Lambda$-modules on $X^\an$.

  \begin{proof}
    We may assume $\sF_\bullet$ is lisse strictly $\ell$-adic. Restricting to a (Zariski-)connected component of $X$, we may assume $X$ is connected. Then all stalks of $\sF_\bullet$ are (abstractly) isomorphic (since $\l(\sF_\bullet\r)_x \iso \lim {\l(\sF_n\r)_x}$ this follows from the property holding for the locally constant constructible sheaves $\sF_n$, which is a consequence of their specialization properties).

    Now fix $x \in X(\bC)$. By \cref{an-lim-stalk} and strictness of $\sF_\bullet$ we have
    \[
      \l(\sF_\bullet^\an\r)_x \big/ \ell^{n+1} \l(\sF_\bullet^\an\r)_x \iso \l(\sF_n\r)_x.
    \]
    In particular we may find an open $U \subseteq X^\an$ containing $x$ and local sections $s_1,\ldots,s_r \in \sF_\bullet^\an(U)$ such that $\{(s_\nu)_x\}$ projects to a $\Lambda_0$-basis of $\l(\sF_0\r)_x$. By shrinking $U$ we may assume $\sF_0$ is constant on $U$ so that in fact $\{(s_\nu)_y\}$ projects to a $\Lambda_0$-basis of $\l(\sF_0\r)_y$ for all $y \in U$.

    Now, for each $y \in U$, $\l(\sF_\bullet^\an\r)_y \iso \l(\sF_\bullet\r)_y$ is a finite $\Lambda$-module, so by Nakayama's lemma $\{(s_\nu)_y\}$ generates $\l(\sF_\bullet^\an\r)_y$. Again shrinking $U$ if necessary, we may assume that the finitely many relations on $\{(s_\nu)_x\}$ in $\l(\sF_\bullet^\an\r)_x$ are satisfied by $\{(s_\nu)_y\}$ in $\l(\sF_\bullet^\an\r)_y$ for all $y \in U$.

    We conclude that there is a finite $\Lambda$-module $M$ and a surjection $\phi \c \u M \to \sF_\bullet^\an|_U$, for $\u M$ the constant sheaf on $U$ with value $M$, such that the induced map $\phi_x \c M \to \l(\sF^\an_\bullet\r)_x$ is an isomorphism. Using \cref{an-lim-stalk} and our restriction to connected $X$, we know all the stalks
    \[
      \l(\sF_\bullet^\an\r)_y \iso \l(\sF_\bullet\r)_y, \quad y \in U
    \]
    are isomorphic. It follows that $\phi$ must be an isomorphism at every $y \in U$, and hence an isomorphism. This proves $\sF_\bullet^\an$ is locally constant, as desired.
  \end{proof}
\end{corollary}

\begin{nothing}
  \label{an-proof}
  We now work towards proving \cref{an-lim-stalk}, though we will only give the proof for the case that $\sF_\bullet$ is lisse; the details for general case of $\sF_\bullet$ constructible may be found in \cite[\S 1.4.7]{conrad-etale}. The proof will require some preliminaries.

  \begin{subremark}
    \label{an-proof-issue}
    Before beginning the argument, it's perhaps worth pointing out where intuitively the difficulty lies. Taking $\sF_\bullet$ to be lisse strictly $\ell$-adic, we have a collection of local systems $\sG_n \ce \sF_n^\an$ on $X^\an$ and want to show that
    \[
      \l(\lim \sG_n\r)_x \iso \lim {\l(\sG_n\r)_x}
    \]
    at each point $x \in X^\an$. This might seem easy as the $\sG_n$ are locally constant. However, it is not easy, as we don't know that we may find a \emph{single} open neighborhood of $x$ on which \emph{all} of the $\sG_n$ are constant. More precisely, while it is clear we may accomplish this in the case that $X$ is smooth, as then $x \in X^\an$ has a contractible neighborhood, it is not clear in the non-smooth case. Our strategy below is to use alterations to bootstrap from the smooth to the general case.
  \end{subremark}
  
  \begin{sublemma}
    \label{an-proof-smooth}
    Let $M$ be a complex manifold and $D \subseteq M$ a normal crossings divisor. Then there exists a base of opens $W$ in $M$ around $D$ such that, for all local systems $\sG$ on $M$, the restriction map $\sG(W) \to \sG(D)$ is an isomorphism.

    \begin{proof}
      As we may replace $M$ with an arbitrary open in $M$ around $D$, it suffices to find one such $W$. In the local picture, $M$ is a polydisk and $D$ the zero locus of a product of coordinate functions; both of these are contractible sets, on which any local system is constant, so the claim is clear.

      We can glue to bootstrap to the global case. Choose open neighborhoods $W'_d$ in $M$ of each $d \in D$ which look like the local picture. Put a Riemannian metric on $M$ and for each $d \in D$ choose $r_d \ge 0$ small enough so that the open ball $W_d \ce \rB_{r_d}(d)$ is geodesically convex and $\rB_{3r_d}(d) \subseteq W'_d$. Set $W \ce \bigcup_{d \in D} W_d$.

      Let $\sG$ be a local system on $M$. For each $d \in D$ we know $\sG(W'_d) \to \sG(W'_d \cap D)$ is an isomorphism. In fact $W'_d$ and $W'_d \cap D$ are contractible, implying $\sG|_{W'_d}$ is constant and $\sG(W'_d \cap D) \to \sG(W_d \cap D)$ is injective. Also $W_d$ is contractible (by convexity) so $\sG(W'_d) \to \sG(W_d)$ is an isomorphism. We deduce that $\sG(W_d) \to \sG(W_d \cap D)$ is injective for each $d \in D$, and it follows that $\sG(W) \to \sG(D)$ is injective.

      We now argue for surjectivity. Fix $s \in \sG(D)$. There exist (unique) $\til{s}(d) \in \sG(W'_d)$ restricting to $s(d) \ce s|_{W'_d \cap D} \in \sG(W'_d \cap D)$. We just need to glue these into a section $\til{s} \in \sG(W)$, so it suffices to show that $\til{s}(d)|_{W_d \cap W_{d'}} = \til{s}(d')|_{W_d \cap W_{d'}}$ for all $d,d' \in D$. If $W_d \cap W_{d'} = \emptyset$ this is trivial. Otherwise, by symmetry we may assume $r_{d'} \le r_d$, and then $W_d \cap W_{d'}$ being nonempty implies that
      \[
        W_{d'} = \rB_{r_{d'}}(d') \subseteq \rB_{3r_d}(d) \subseteq W'_d.
      \]
      In particular $d' \in W'_d$, implying
      \[
        \til{s}(d)_d = \til{s}(d)_{d'} = s(d)_{d'} = s_{d'} = s(d')_{d'} = \til{s}(d')_{d'}.
      \]
      Finally any $w \in W_d \cap W_{d'}$ admits paths to $d$ and to $d'$, so we get
      \[
        \til{s}(d)_w = \til{s}(d)_d = \til{s}(d')_{d'} = \til{s}(d')_w,
      \]
      proving the desired gluability.
    \end{proof}
  \end{sublemma}

  \begin{sublemma}
    \label{an-proof-espace}
    Let $T' \to T$ be a quotient map of topological spaces. Let $T'' \ce T' \times_T T'$. Let $\sG$ be a sheaf of sets on $T$, and let $\sG'$ and $\sG''$ be the pullbacks of $\sG$ to $T'$ and $T''$. Then the sequence
    \[
      \sG(T) \to \sG'(T') \doubto \sG''(T'')
    \]
    is an equalizer sequence.

    \begin{proof}
      Let $\pi \c E \to T$ be the espace \'etal\'e associated to $\sG$, so that elements of $\sG(T)$ are given by (continuous) sections of $\pi$. Similarly take $\pi' \c E' \to T'$ and $\pi'' \c E'' \to T''$ associated to $\sG'$ and $\sG''$; these are obtained by pulling back $\pi$ to $T'$ and $T''$, so $E' \iso E \times_T T'$ and $E'' \iso E \times_T T''$. The claim now follows from the universal property of a quotient map.
    \end{proof}
  \end{sublemma}
  
  \begin{sublemma}
    \label{an-proof-alter}
    Suppose $X$ is separated. Let $Y$ be a (Zariski-)closed subset of $X$.
    \begin{enumerate}
    \item \label{an-proof-alter-inj}
      Fix an open $U \subseteq X^\an$ around $Y^\an$. There is an open $V \subseteq U$ around $Y^\an$ such that, for all local systems $\sG$ on $X^\an$, the restriction map
      \[
        \im\l(\sG(U) \to \sG(V)\r) \to \sG(Y^\an)
      \]
      is injective.
    \item \label{an-proof-alter-surj}
      There exists an open $U \subseteq X^\an$ around $Y^\an$ such that, for all local systems $\sG$ on $X^\an$, the restriction map $\sG(U) \to \sG(Y^\an)$ is surjective.
    \end{enumerate}
    
    \begin{proof}
      Let $g \c \til{X} \to X$ be the normalization of $X_\red$, and $\til{Y} \ce g^{-1}(Y)$. Note that $\til{X}$ is separated since $X$ is. Thus we may apply de Jong's alterations theorem to each connected/irreducible component $\til{X}_i$ of $\til{X}$, together with the proper closed subset
      \[
        \begin{cases}
          \til{X}_i \cap \til{Y} & \text{if}\ \til{X}_i \cap \til{Y} \ne \til{X}_i \\
          \emptyset & \text{otherwise}.
        \end{cases}
      \]
      We obtain a smooth quasi-projective $\bC$-scheme $X_0$ and a generically finite surjective proper map $f \c X_0 \to X$ such that $Y_0 \ce f^{-1}(Y) = Y_1 \amalg Y_2$ with $Y_1$ a union of some connected components of $X_0$ and $Y_2$ a strict normal crossings divisor in the remaining components.

      Applying \cref{an-proof-smooth} with $M = X_0^\an$ and $D = Y_2^\an$, we find a base $\kB$ of opens $W \subseteq X_0^\an$ around $Y_0^\an$ for which restriction $\sG(W) \to \sG(Y_0^\an)$ is an isomorphism for all local systems $\sG$ on $X_0^\an$. With all this preparation in hand, we now address the two claims:
      \begin{enumerate}[leftmargin=*]
      \item
        Choose an open $W_0 \in \kB$ contained in $U_0 \ce (f^\an)^{-1}(U)$. As $f$ is proper, $f^\an \c X_0^\an \to X^\an$ is closed, so we may find an open $V \subseteq U$ containing $Y^\an$ such that $V_0 \ce f^{-1}(V) \subseteq W_0$.

        Let $\sG$ be any local system on $X^\an$, set $\sG_0 \ce (f^\an)^*(\sG)$, and consider the commutative diagram
        \[
          \begin{tikzcd}
            \sG(U) \ar[rr] \ar[d] &
            &
            \sG(V) \ar[r] \ar[d] &
            \sG(Y^\an) \ar[d] \\
            \sG_0(U_0) \ar[r] &
            \sG_0(W_0) \ar[r] &
            \sG_0(V_0) \ar[r] &
            \sG_0(Y_0^\an).
          \end{tikzcd}
        \]
        We want to show that an element of $\sG(U)$ that dies in $\sG(Y^\an)$ already dies in $\sG(V)$. To deduce this from the diagram, we observe that the analogous property holds for $\sG_0(U_0), \sG_0(W_0), \sG(Y_0^\an)$ since $W_0 \in \kB$, and that the map $\sG(V) \to \sG(V_0)$ is injective, by stalk considerations, since $f$ is surjective.

      \item Let $X_{00} \ce X_0 \times_X X_0$. Let $Y_{00}$ be the closed subset $Y_0 \times_X Y_0 \subseteq X_{00}$ (putting, say, the reduced scheme structure on $Y_0 \subseteq X_0$ to form this fiber product).

        Choose an open $W_0 \in \kB$. Let $W_{00} \ce W_0 \times_X W_0$, an open in $X_{00}$ around $Y_{00}$. By \cref{an-proof-alter-inj} we may choose an open $V_{00} \subseteq W_{00}$ around $Y_{00}$ such that, for all local systems $\sG_{00}$ on $X_{00}$, the restriction map
        \begin{equation}
          \label{an-proof-alter-surj-inj}
          \im\l(\sG(W_{00}) \to \sG(V_{00})\r) \to \sG(Y_{00}^\an)
        \end{equation}
        is injective. Again using that $f$ is proper and hence $f^\an$ closed, we may find an open $U \subseteq X^\an$ whose preimage $U_{00}$ in $X_{00}$ is contained in $V_{00}$; this implies that also $U_0 \ce (f^\an)^{-1}(U)$ is contained in $W_0$.

        Now suppose given a local system $\sG$ on $X^\an$ and $s \in \sG(Y^\an)$. Setting $\sG_0 \ce (f^\an)^*(\sG)$, we get a pullback $s_0 \in \sG_0(Y_0^\an)$. Since $W_0 \in \kB$ this extends (uniquely) to a section $\til{s}_0 \in \sG_0(W_0)$. To finish, we'd like to descend $\til{s}_0|_{U_0}$ to $U$. Let $\sG_{00}$ be the pull back of $\sG$ to $X_{00}^\an$. By the injectivity of \cref{an-proof-alter-surj-inj} we deduce that the two pullbacks of $\til{s}_0$ to $\sG_{00}(V_{00})$ agree, and hence the two pullbacks of $\til{s}_0|_{U_0}$ to $\sG_{00}(U_{00})$ agree. We are then done by \cref{an-proof-espace}, as $f^\an \c U_0 \to U$ is a closed surjection, hence a quotient map, and $U_{00} \iso U_0 \times_U U_0$. \qedhere
      \end{enumerate}
    \end{proof}
  \end{sublemma}
  
  \begin{proof}[Proof of \cref{an-lim-stalk} for $\sF_\bullet$ lisse]
    The question is local on $X$ so we may assume $X$ is separated. We are assuming $\sF_\bullet$ is lisse, and we may moreover assume $\sF_\bullet$ is lisse strictly $\ell$-adic so that each $\sF_n$ is locally constant constructible; then each $\sF_n^\an$ is a local system on $X^\an$.

    Fix $x \in X(\bC)$. Applying \cref{an-proof-alter} to $Y = \{x\} \subseteq X$, we may find a sequence of pairs of opens $V_m \subseteq U_m \subseteq X^\an$ around $x$ such that:
    \begin{enumerate}
    \item $U_{m+1} \subseteq V_m$ for $m \in \bN$;
    \item \label{an-proof-base} $\{U_m\}_{m \in \bN}$ is a base at $x$ (the ability to choose a countable base follows from the fact that $X^\an$ has the topology of a subspace in some affine space $\bC^d$);
    \item \label{an-proof-resiso} the restriction map
      \[
        I_{n,m} \ce \im\l((\sF_n^\an(U_m) \to \sF_n(V_m^\an)\r) \to \l(\sF_n^\an\r)_x \iso \l(\sF_n\r)_x
      \]
      is an isomorphism for all $m,n \in \bN$.
    \end{enumerate}
    
    We now show that the map $\iota_x \c \l(\sF_\bullet^\an\r)_x \to \l(\sF_\bullet\r)_x$ is bijective. For surjectivity, observe that by \cref{an-proof-resiso} every element of $\l(\sF_\bullet\r)_x = \lim {\l(\sF_n\r)_x}$ arises from an element of $\lim I_{n,m} \subseteq \sF_\bullet^\an(V_m)$ for any fixed $m$. For injectivity, observe that by \cref{an-proof-base} any element of $s_x \in \l(\sF_\bullet^\an\r)_x$ has a representative $s \in \sF_\bullet^\an(U_m)$ for some $m \in \bN$, and if it vanishes under $\iota_x$ then by \cref{an-proof-resiso} we must have $s|_{V_m} = 0$, implying $s_x = 0$.
  \end{proof}
\end{nothing}

% ---------------------------------------------------------------------

\section{Adic comparison}
\label{comp}

We now arrive at the main result, the adic Artin comparison isomorphism:

\begin{theorem}
  \label{comp-main}
  Let $f \c X \to S$ be a separated morphism between finite-type $\bC$-schemes. Let $\sF_\bullet$ be a constructible $\Lambda$-sheaf on $X$. Then, for $p \ge 0$, the canonical maps
  \[
    \begin{tikzcd}[row sep = tiny]
      \l(\rR^pf_!(\sF_\bullet)\r)^\an \ar[r, "\alpha_1"] &
      \lim \rR^pf^\an_!(\sF_n^\an) &
      \rR^p f^\an_!(\sF_\bullet^\an) \ar[l, "\alpha_2", swap] \\
      \l(\rR^pf_*(\sF_\bullet)\r)^\an \ar[r, "\beta_1"] &
      \lim \rR^pf^\an_*(\sF_n^\an) &
      \rR^p f^\an_*(\sF_\bullet^\an) \ar[l, "\beta_2", swap]
    \end{tikzcd}
  \]
  are isomorphisms.

  \begin{subnothing}
    \label{comp-a1b1}
    Alas, here we will only prove that $\alpha_1, \alpha_2, \beta_1$ are isomorphisms. We first give the (easy) argument for $\alpha_1, \beta_1$.

    \begin{proof}[Proof of \cref{comp-main} for $\alpha_1,\beta_1$]
      By definition we have
      \[
        \l(\rR^pf_!(\sF_\bullet)\r)^\an \iso \lim {\l(\rR^pf_!(\sF_n)\r)^\an}.
      \]
      We may assume $\sF_\bullet$ is a constructible strictly $\ell$-adic sheaf, so that each $\sF_n$ is constructible torsion. Then by the Artin comparison theorem for torsion coefficients we have canonical isomorphisms
      \begin{equation}
        \label{comp-a1b1-torsion}
        \l(\rR^pf_!(\sF_n)\r)^\an \isoto \rR^pf^\an_!(\sF_n^\an).
      \end{equation}
      As $\alpha_1$ is precisely the map induced by these isomorphisms, it too is an isomorphism. The same argument, with $f_!$ and $f^\an_!$ replaced by $f_*$ and $f^\an_*$, demonstrates that $\beta_1$ is an isomorphism.
    \end{proof}
  \end{subnothing}
\end{theorem}

\begin{nothing}
  \label{comp-a2}
  We now work towards proving the claim for $\alpha_2$, first establishing several tools that will be needed in the proof.

  \begin{subterminology}
    \label{comp-a2-terminology}
    Given a separated morphism of finite-type $\bC$-schemes $f \c X \to S$, we will say ``$\alpha_2(f)$ is an isomorphism'' if for this fixed morphism $f$ the map $\alpha_2$ of \cref{comp-main} is an isomorphism for all constructible $\Lambda$-sheaves $\sF_\bullet$ on $X$.
  \end{subterminology}

  \begin{sublemma}
    \label{comp-a2-fiber}
    Let $f \c X \to S$ be a separated morphism of finite type $\bC$-schemes. For $s \in S(\bC)$ let $f_s \c X_s \to \Spec(\bC)$ be the fiber of $f$ over $s$. Suppose $\alpha_2(f_s)$ is an isomorphism for all $s \in S(\bC)$. Then $\alpha_2(f)$ is an isomorphism.
    
    \begin{proof}
      It suffices to show for each $s \in S^\an$ that the map on stalks
      \[
        (\alpha_2)_s \c \l(\rR^p f^\an_!(\sF_\bullet^\an)\r)_s \to \l(\lim \rR^pf^\an_!(\sF_n^\an)\r)_s
      \]
      is an isomorphism. By \cref{comp-a1b1-torsion} and \cref{an-lim-stalk} the canonical map
      \[
        \l(\lim \rR^pf^\an_!(\sF_n^\an)\r)_s \to \lim {\l(\rR^pf^\an_!(\sF_n^\an)\r)_s}
      \]
      is an isomorphism. The claim thus follows from proper base change.
    \end{proof}
  \end{sublemma}
  
  \begin{sublemma}
    \label{comp-a2-leray}
    Let $S \ce \Spec(\bC)$. Suppose given a commutative diagram
    \[
      \begin{tikzcd}
        Y \ar[rr, "g"] \ar[rd, "h", swap] &
        &
        X \ar[ld, "f"] \\
        &
        S
        &
      \end{tikzcd}
    \]
    of separated morphisms between finite type $\bC$-schemes. Suppose that $\alpha_2(f), \alpha_2(g)$ are isomorphisms. Then $\alpha_2(h)$ is an isomorphism.

    \begin{proof}
      Let $\sF_\bullet$ be a constructible $\Lambda$-sheaf on $Y$. For each $n \in \bN$ we have a Leray spectral sequence
      \[
        \rH_\rc^p(X^\an; \rR^qg^\an_!(\sF_n^\an))
        \quad \implies \quad
        \rH_\rc^{p+q}(Y^\an; \sF_n^\an);
      \]
      let us denote this spectral sequence by $E_n$. We may assume that $\sF_\bullet$ is constructible strictly $\ell$-adic, so each $\sF_n$ (and hence $\sF_n^\an$) is constructible. Then by the torsion Artin comparison isomorphism we have
      \[
        \rR^qg^\an_!(\sF_n^\an) \iso \l(\rR^qg_!(\sF_n)\r)^\an,
      \]
      which we know is constructible. We then similarly deduce that the cohomology groups
      \[
        \rH_\rc^p(X^\an; \rR^qg^\an_!(\sF_n^\an)), \quad \rH_\rc^{p+q}(Y^\an; \sF_n^\an)
      \]
      are all finite. Therefore, for each $p,q \ge 0$ the inverse systems
      \[
        \l\{\rH_\rc^p(X^\an; \rR^qg^\an_!(\sF_n^\an))\r\}_{n \in \bN}, \quad
        \l\{\rH_\rc^{p+q}(Y^\an; \sF_n^\an)\r\}_{n \in \bN}
      \]
      satisfy the Mittag-Leffler condition. Taking inverse limits of these systems is therefore exact, so that $\lim E_n$ gives a spectral sequence
      \[
        \lim \rH_\rc^p(X^\an; \rR^qg^\an_!(\sF_n^\an))
        \quad \implies \quad
        \lim \rH_\rc^{p+q}(Y^\an; \sF_n^\an).
      \]

      We also have a Leray spectral sequence for $\sF_\bullet$,
      \[
        \rH_\rc^p(X^\an;\rR^qg^\an_!(\sF_\bullet^\an))
        \quad \implies \quad
        \rH_\rc^{p+q}(Y^\an;\sF_\bullet^\an);
      \]
      let us denote this one by $E_\bullet$. There is a map of spectral sequences $\alpha_2 \c E_\bullet \to \lim E_n$ which on the initial page is given by the composition
      \[
        \rH_\rc^p(X^\an;\rR^qg^\an_!(\sF_\bullet^\an)) \lblto{\alpha_2(g)}
        \rH_\rc^p(X^\an;\lim \rR^qg^\an_!(\sF_n^\an)) \lblto{\alpha_2(f)}
        \lim \rH_\rc^p(X^\an;\rR^qg^\an_!(\sF_n^\an))
      \]
      and on the abutment is given by $\alpha_2(h)$. Our hypothesis implies that the map of spectral sequences is an isomorphism on the initial page, and hence it must be on the abutments as well.
    \end{proof}
  \end{sublemma}

  \begin{sublemma}
    \label{comp-a2-excision}
    Let $S \ce \Spec(\bC)$. Let $f \c X \to S$ be a separated morphism of finite type $\bC$-schemes. Let $j \c U \inj X$ be an open subscheme and let $i \c Z \inj X$ denote its closed complement (with the reduced scheme structure). Define
    \[
      g \ce f \circ j \c U \to S, \quad
      h \ce f \circ i \c Z \to S,
    \]
    and suppose $\alpha_2(g), \alpha_2(h)$ are isomorphisms. Then $\alpha_2(f)$ is an isomorphism.

    \begin{proof}
      Let $\sF_\bullet$ be a constructible $\Lambda$-sheaf on $X$. For each $n \in \bN$ we have an excision sequence
      \[
        \cdots \to \rH_\rc^p(U^\an, \sF_n^\an) \to \rH_\rc^p(X^\an, \sF_n^\an) \to \rH_\rc^p(Z^\an, \sF_n^\an) \to \rH_\rc^{p+1}(U^\an, \sF_n^\an) \to \cdots.
      \]
      We may assume that $\sF_\bullet$ is constructible strictly $\ell$-adic, so each $\sF_n$ is constructible. As in the proof of \cref{comp-a2-leray}, torsion Artin comparison implies that all these cohomology groups are finite, and hence for each $p \ge 0$ the inverse systems
      \[
        \l\{\rH_\rc(U^\an, \sF_n^\an)\r\}_{n \in \bN}, \quad
        \l\{\rH_\rc(X^\an, \sF_n^\an)\r\}_{n \in \bN}, \quad
        \l\{\rH_\rc(Z^\an, \sF_n^\an)\r\}_{n \in \bN}
      \]
      all satisfy the Mittag-Leffler condition. Taking inverse limits of these systems is therefore exact, so the sequence
      \[
        \cdots \to \lim \rH_\rc^p(U^\an, \sF_n^\an) \to \lim \rH_\rc^p(X^\an, \sF_n^\an) \to \lim \rH_\rc^p(Z^\an, \sF_n^\an) \to \cdots
      \]
      remains exact.

      We also have an excision sequence for $\sF_\bullet$, and, using \cref{an-open} and \cref{an-closed}, we get a commutative diagram
      \[
        \begin{tikzcd}[column sep = small]
          \cdots \ar[r] &
          \rH_\rc^p(U^\an, \sF_\bullet^\an) \ar[r] \ar[d, "\alpha_2(g)"] &
          \rH_\rc^p(X^\an, \sF_\bullet^\an) \ar[r] \ar[d, "\alpha_2(f)"] &
          \rH_\rc^p(Z^\an, \sF_\bullet^\an) \ar[r] \ar[d, "\alpha_2(h)"] &
          \cdots \\
          \cdots \ar[r] &
          \lim\rH_\rc^p(U^\an, \sF_n^\an) \ar[r] &
          \lim\rH_\rc^p(X^\an, \sF_n^\an) \ar[r] &
          \lim\rH_\rc^p(Z^\an, \sF_n^\an) \ar[r] &
          \cdots
        \end{tikzcd}
      \]
      with exact rows. The claim now follows from the five-lemma.
    \end{proof}
  \end{sublemma}

  % \begin{sublemma}
  %   \label{comp-a2-open}
  %   Suppose $f \c X \inj S$ is an open immersion of finite-type $\bC$-schemes. Then $\alpha_2(f)$ is an isomorphism.

  %   \begin{proof}
  %     In this situation $f_!$ and $f^\an_!$ are simply extension by zero. In particular $f^\an_!$ is exact, so $\rR^p f^\an_!$ vanishes for $p > 0$. Thus we need only check, for $\sF_\bullet$ a constructible $\Lambda$-sheaf on $X$, that
  %     \[
  %       \alpha_2 \c f^\an_!(\sF_\bullet^\an) \to \lim f^\an_!(\sF_n^\an)
  %     \]
  %     is an isomorphism. This is \cref{an-open}\cref{an-open-push}.
  %   \end{proof}
  % \end{sublemma}

  \begin{sublemma}
    \label{comp-a2-finite}
    Suppose $f \c X \to S$ is a finite morphism of finite-type $\bC$-schemes. Then $\alpha_2(f)$ is an isomorphism.

    \begin{proof}
      In this situation $f_! = f_*$ and $f_*$ is exact. So $\rR^p f^\an_!$ vanishes for $p > 0$ and we need only check, for $\sF_\bullet$ a constructible $\Lambda$-sheaf on $X$, that
      \[
        \alpha_2 \c f^\an_*(\sF_\bullet^\an) \to \lim f^\an_*(\sF_n^\an)
      \]
      is an isomorphism. This follows from the fact that $f_*$ preserves limits.
    \end{proof}
  \end{sublemma}
  
  \begin{sublemma}
    \label{comp-a2-lim}
    Let $T$ be a topological space. Let $\{\sF_n\}_{n \in \bN}$ be an inverse system of abelian sheaves on $T$. Assume that:
    \begin{enumerate}
    \item \label{comp-a2-lim-basis}
      there is a basis $\kU$ of $T$ such that:
      \begin{enumerate}
      \item the inverse system $\l\{\sF_n(U)\r\}_{n \in \bN}$ satisfies the Mittag-Leffler criterion for all $U \in \kU$;
      \item $\rH^p(U;\sF_n) \iso 0$ for all $U \in \kU, p > 0, n \in \bN$;
      \end{enumerate}
    \item \label{comp-a2-lim-ML}
      for each $p \ge 0$ the inverse system of abelian groups $\l\{\rH^p(T;\sF_n)\r\}_{n \in \bN}$ satisfies the Mittag-Leffler criterion.
    \end{enumerate}
    Then, for $p \ge 0$, the canonical map
    \[
      \rH^p(T,\lim \sF_n) \to \lim {\rH^p(T,\sF_n)}
    \]
    is an isomorphism.

    \begin{proof}
      Let $\Ab$ denote the category of abelian groups and $\Ab(T)$ the category of abelian sheaves on $T$; let $\Ab^\bN$ and $\Ab(T)^\bN$ denote the categories of inverse systems in $\Ab$ and $\Ab(T)$. As $\Gamma \c \Ab(T) \to \Ab$ preserves limits, we get a commutative diagram of left-exact functors
      \[
        \begin{tikzcd}
          \Ab(T)^\bN \ar[r, "\lim"] \ar[d, "\Gamma", swap] &
          \Ab(T) \ar[d, "\Gamma"] \\
          \Ab^\bN \ar[r, "\lim"] &
          \Ab.
        \end{tikzcd}
      \]
      Taking (total) right-derived functors, we see that $\rR\Gamma \circ \rR\lim \iso \rR\lim \circ \rR\Gamma$, so we have
      \[
        \rR\Gamma(T, \rR\lim \sF_n) \iso \rR\lim \rR\Gamma(T, \sF_n).
      \]
      On the left-hand side, assumption \cref{comp-a2-lim-basis} implies that $\rR \lim \sF_n \iso \lim \sF_n$ \cite[Tag 0BKS]{stacks-project}. To address the right-hand side, consider the Grothendieck spectral sequence
      \[
        \rR^q \lim \rH^p(T, \sF_n)
        \quad \implies \quad
        \rH^{p+q}(\rR\lim \rR\Gamma(T, \sF_n)).
      \]
      In the same way, assumption \cref{comp-a2-lim-ML} implies that $\rR^q \lim \rH^p(T, \sF_n) \iso 0$ for all $q > 0$, so the spectral sequence immediately degenerates. Combining this with the prior observations, we obtain isomorphisms
      \[
        \rH^p(T, \lim \sF_n) \iso \lim \rH^p(T, \sF_n),
      \]
      which one should check arise from the canonical map, as desired.\footnote{I learned this argument from a comment on \url{http://mathoverflow.net/q/65249}.}
    \end{proof}
  \end{sublemma}

  \begin{sublemma}
    \label{comp-a2-smooth}
    Let $S \ce \Spec(\bC)$. Suppose $f \c X \to S$ is a smooth morphism of finite-type $\bC$-schemes. Then
    \[
      \beta_2 \c \rH^p(X^\an; \sF_\bullet^\an) \to \lim \rH^p(X^\an; \sF_n^\an)
    \]
    is an isomorphism for all lisse $\Lambda$-sheaves $\sF_\bullet$ on $X$.

    \begin{proof}
      It suffices to consider a lisse strictly $\ell$-adic sheaf $\sF_\bullet$; thus the sheaves $\sF_n$ are locally constant constructible, and hence the sheaves $\sF_n^\an$ are local systems. We now have the following:
      \begin{enumerate}
      \item Since $f$ is smooth, $X^\an$ is a complex manifold, and hence its topology has a basis $\kU$ consisting of contractible opens.
        \begin{enumerate}
        \item The strictness of $\sF_\bullet$ implies that the transition maps $\sF_n \to \sF_{n-1}$ are surjective, by strictness of $\sF_\bullet$. This implies that the same holds for the analytified transition maps $\sF_n^\an \to \sF_{n-1}^\an$ (by exactness of analytification). As the sheaves $\sF_n^\an$ are local systems, $\sF_n^\an|_U$ is constant for each $U \in \kU$, so we also have that $\sF_n^\an(U) \to \sF_{n-1}(U)$ is surjective.
        \item That $\sF_n^\an$ are local systems also implies that $\rH^p(U;\sF_n^\an) \iso 0$ for all $U \in \kU, p > 0, n \in \bN$.
        \end{enumerate}
      \item The sheaves $\sF_n$ being (locally constant) constructible also implies that the cohomology groups
      \[
        \rH^p(X^\an; \sF_n^\an) \iso \rH^p(X;\sF_n)
      \]
      are finite. Thus, for each $p \ge 0$, the system $\l\{\rH^p(X^\an; \sF_n^\an)\r\}$ satisfies the Mittag-Leffler criterion.
      \end{enumerate}
      That $\beta_2$ is an isomorphism thus follows from \cref{comp-a2-lim}.
    \end{proof}
  \end{sublemma}

  \begin{proof}[Proof of \cref{comp-main} for $\alpha_2$]
    By \cref{comp-a2-fiber} we may reduce to the case that $S = \Spec(\bC)$. Then by noetherian induction and \cref{comp-a2-excision} we may reduce to the case that $X$ is affine. By Noether normalization we have a factorization of $f \c X \to S$ as a composite
    \[
      X \lblto{g} \bA^d_\bC \to \bA^{d-1}_\bC \to \cdots \to \bA^1_\bC \to S
    \]
    where $g$ is finite. Now applying \cref{comp-a2-leray} and \cref{comp-a2-finite} and then again \cref{comp-a2-fiber}, we are reduced to the case that $f \c X \to S$ is a smooth curve over $\Spec(\bC)$. And again using noetherian induction and \cref{comp-a2-excision}, we may reduce to the case that furthermore $\sF_\bullet$ is lisse.

    If $f$ is proper then $f_! \iso f_*$ and $\alpha_2 \iso \beta_2$ so by \cref{comp-a2-smooth} we are done. Otherwise $X^\an$ is a punctured Riemann surface. Let us remind ourselves that our goal is to show
    \[
      \alpha_2 \c \rH_\rc^p(X^\an, \sF_\bullet^\an) \to \lim \rH_\rc^p(X^\an, \sF_n^\an)
    \]
    is an isomorphism. For any sheaf $\sG$ on $X^\an$ we have
    \[
      \rH_\rc^p(X^\an,\sG) \iso \colim_{\Delta^*} \rH_{X^\an \setminus \Delta^*}^p(X^\an; \sG),
    \]
    where the colimit is over shrinking punctured-disk neighborhoods $\Delta^*$ of the punctures of $X^\an$.

    By considering the excision sequence
    \[
      \cdots \to \rH_{X^\an \setminus \Delta^*}^p(X^\an; \sG) \to \rH^p(X^\an; \sG) \to \rH^p(\Delta^*; \sG) \to \cdots
    \]
    and noting that the homotopy type of $\Delta^*$ does not change as it shrinks, we observe that the transition maps in the direct system $\l\{\rH_{X^\an \setminus \Delta^*}^p(X^\an; \sG)\r\}_{\Delta^*}$ are isomorphisms when $\sG$ is a local system. We may assume $\sF_\bullet$ to be lisse strictly $\ell$-adic, so the sheaves $\sF_n^\an$ are local systems, and by \cref{an-lisse-local} $\sF_\bullet^\an$ is a local system. We conclude from this and the above excision sequence that it suffices to show that the canonical maps
    \[
      \rH^p(X^\an;\sF_\bullet^\an) \to \lim \rH^p(X^\an;\sF_n^\an), \quad
      \rH^p(\Delta^*;\sF_\bullet^\an) \to \lim \rH^p(\Delta^*;\sF_n^\an)
    \]
    are isomorphisms. We're now done by \cref{comp-a2-smooth}.
  \end{proof}
\end{nothing}

\begin{remark}
  \label{comp-K}
  The adic Artin comparison isomorphism also holds for $K$- and $\o K$-sheaves (recall $K$ is the fraction field of $\Lambda$). To deduce this from the result for $\Lambda$-sheaves \cref{comp-main} one only needs to check that
  \[
    \rR^pf^\an_!(K \otimes_\Lambda \sF_\bullet^\an) \iso K \otimes_\Lambda \rR^pf^\an_!(\sF_\bullet^\an), \quad
    \rR^pf^\an_*(K \otimes_\Lambda \sF_\bullet^\an) \iso K \otimes_\Lambda \rR^pf^\an_*(\sF_\bullet^\an),
  \]
  and similarly with $K$ replaced by $\o K$. For pushforward with proper supports this follows from the fact that $\rR^pf^\an_!$ preserves colimits, as $K,\o K$ can be written as a colimit of finite free $\Lambda$-modules. As with \cref{comp-main}, the situation for ordinary pushforward is more subtle and will not be discussed here.
\end{remark}

% ---------------------------------------------------------------------

\begin{thebibliography}{BrTIII}

\bibitem[Conrad]{conrad-etale} Brian Conrad, \emph{\'Etale cohomology}, unpublished notes.

\bibitem[Stacks]{stacks-project} The Stacks Project Authors, \emph{Stacks Project}, \url{http://stacks.math.columbia.edu}, 2017.

\end{thebibliography}

\end{document}
